<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VG Optimizer | v2.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --baseline: #10b981; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #1e293b; --muted: #64748b; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 100vh; overflow: hidden; }

        .sidebar { background: var(--primary); color: white; padding: 25px; overflow-y: auto; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: flex-start; gap: 22px; }
        .sidebar h1 { font-size: 18px; font-weight: 700; color: white; }
        .filter-group { width: 100%; display: flex; flex-direction: column; align-items: flex-start; }
        .filter-label { font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
        .multi-box { background: #1e293b; border-radius: 6px; height: 115px; width: 100%; overflow-y: auto; padding: 10px; border: 1px solid #334155; }
        .item-row { display: flex; align-items: center; justify-content: flex-start; gap: 10px; padding: 6px 0; font-size: 12px; color: #cbd5e1; width: 100%; cursor: pointer; }
        
        select, .search-input { background: #1e293b; color: #ffffff; border: 1px solid #334155; padding: 10px; border-radius: 4px; width: 100%; font-size: 12px; outline: none; }
        
        /* PoP View Dropdown Spacing */
        .pop-controls { display: flex; align-items: center; gap: 20px; } /* Added 20px gap here */
        .card select { background: #ffffff; color: var(--text); border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; }

        .main-container { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }
        .card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        svg { width: 100%; height: 400px; overflow: visible; }
        .line-base { fill: none; stroke: var(--baseline); stroke-width: 2.5; }
        .line-sim { fill: none; stroke: var(--accent); stroke-width: 4; stroke-linecap: round; }
        .label-base { font-size: 10px; font-weight: 700; fill: var(--baseline); }
        .label-delta { font-size: 11px; font-weight: 800; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; font-size: 11px; color: var(--muted); border-bottom: 2px solid var(--border); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }

        .driver-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .btn-sm { padding: 2px 6px; font-size: 9px; cursor: pointer; border: 1px solid #334155; border-radius: 4px; background: transparent; color: #94a3b8; }
        
        #loader { position: fixed; inset: 0; background: var(--primary); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div id="load-text">Syncing v2.2 Metrics...</div></div>

<aside class="sidebar">
    <header><h1>VG Optimizer</h1><p style="font-size: 10px; color: #64748b;">VERSION 2.2</p></header>
    <div class="filter-group"><label class="filter-label">Metric View</label><select id="m-select" onchange="update()"><option value="eligRate">Eligibility %</option><option value="offRate">Offer Rate %</option><option value="accRate">Accept Rate %</option><option value="convRate">Conversion %</option></select></div>
    <div class="filter-group"><label class="filter-label">Business Unit</label><select id="f-bu" onchange="applyContext()"></select></div>
    <div class="filter-group"><div style="display:flex; justify-content:space-between; width:100%"><label class="filter-label">Tiers</label><button class="btn-sm" onclick="toggleAll('tier', true)">All</button></div><div id="f-tier-list" class="multi-box"></div></div>
    <div class="filter-group"><div style="display:flex; justify-content:space-between; width:100%"><label class="filter-label">Sites</label><button class="btn-sm" onclick="toggleAll('site', true)">All</button></div><div id="f-site-list" class="multi-box"></div></div>
    <div class="filter-group"><label class="filter-label">Exclude Types</label><div id="f-type-list" class="multi-box"></div></div>
    <div class="filter-group"><label class="filter-label">Exclude Offers</label><input type="text" id="off-search" class="search-input" placeholder="Search..." oninput="filterOffers()"><div id="f-offer-list" class="multi-box" style="height: 140px; margin-top:8px;"></div></div>
</aside>

<main class="main-container">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="margin:0; font-size:18px; font-weight:700;">Performance Trend</h2>
            <div style="font-size:12px; font-weight:700;"><span style="color:var(--baseline)">━ Baseline</span> &nbsp; <span style="color:var(--accent)">━ Simulated</span></div>
        </div>
        <svg id="chart"></svg>
    </div>

    <div class="driver-grid">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div class="pop-controls">
                    <h3 id="pop-title" style="margin:0; font-size:15px;">Top Drivers</h3>
                    <select id="pop-level" onchange="update()"><option value="typeStatsNum">By Type</option><option value="comboStatsNum">By Combo</option></select>
                </div>
                <select id="period-select" onchange="update()"></select>
            </div>
            <table id="pop-table"><thead><tr><th>Dimension</th><th>Impact Bar</th><th>Contribution</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
            <label class="filter-label" style="color:var(--muted)">Simulation Shift</label>
            <div id="total-delta" style="font-size:42px; font-weight:800; color:var(--accent);">0.00%</div>
        </div>
    </div>
</main>

<script>
    const worker = new Worker('worker.js');
    let displayDates = [], allRelations = {};

    worker.onmessage = (e) => {
        const { type, loaded, displayDates: dDates, bus, relations, base, impact, periodIdx } = e.data;
        if (type === 'READY') {
            displayDates = dDates; allRelations = relations;
            const buS = document.getElementById('f-bu'); bus.forEach(v => buS.add(new Option(v, v)));
            const pS = document.getElementById('period-select'); dDates.forEach((d, i) => i > 0 && pS.add(new Option(`${dDates[i-1]} → ${d}`, i)));
            applyContext();
        }
        if (type === 'DONE') {
            document.getElementById('loader').style.display = 'none';
            renderChart(base, impact, document.getElementById('m-select').value);
            renderTable(base, periodIdx, document.getElementById('m-select').value); // Table now uses organic 'base'
        }
    };

    function applyContext() {
        const bu = document.getElementById('f-bu').value; const data = allRelations[bu]; if(!data) return;
        const fill = (id, items, cls) => { const el = document.getElementById(id); if(el) el.innerHTML = items.map(v => `<label class="item-row"><input type="checkbox" checked class="${cls}-cb" value="${v}" onchange="update()"><span>${v}</span></label>`).join(''); };
        fill('f-tier-list', data.tiers, 'tier'); fill('f-site-list', data.sites, 'site'); fill('f-type-list', data.types, 'type'); fill('f-offer-list', data.offers, 'off');
        update();
    }

    function filterOffers() {
        const q = document.getElementById('off-search').value.toLowerCase();
        document.querySelectorAll('#f-offer-list .item-row').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(q) ? 'flex' : 'none'; });
    }

    function update() {
        document.getElementById('loader').style.display = 'flex';
        const key = document.getElementById('m-select').value;
        const getCheck = (cls, checked) => Array.from(document.querySelectorAll(`.${cls}-cb${checked?':checked':':not(:checked)'}`)).map(c => c.value);
        worker.postMessage({ type: 'PROCESS', exclOff: getCheck('off', false), exclTyp: getCheck('type', false), metricKey: key, filters: { bu: document.getElementById('f-bu').value, sites: getCheck('site', true), tiers: getCheck('tier', true) }, pIdx: parseInt(document.getElementById('period-select').value) || 1 });
    }

    function renderChart(base, sim, key) {
        const svg = document.getElementById('chart'), w = svg.clientWidth, h = 400, m = 60;
        const getX = (i) => m + (i * (w - m * 2) / (base.length - 1));
        const getY = (v) => (h - 100) - (v * (h - 150) / 100);
        let html = `<line x1="${m}" y1="${h-100}" x2="${w-m}" y2="${h-100}" stroke="var(--border)" />`;
        const bPts = base.map((d,i) => `${getX(i)},${getY(d[key])}`).join(' ');
        const sPts = sim.map((d,i) => `${getX(i)},${getY(d[key])}`).join(' ');
        html += `<polyline class="line-base" points="${bPts}" /><polyline class="line-sim" points="${sPts}" />`;
        sim.forEach((d, i) => {
            const x = getX(i), y = getY(d[key]), by = getY(base[i][key]), diff = d[key] - base[i][key];
            html += `<text x="${x}" y="${h-40}" text-anchor="middle" font-size="10" font-weight="600" fill="var(--muted)">${displayDates[i]}</text>`;
            html += `<text x="${x}" y="${by-10}" class="label-base" text-anchor="middle">${base[i][key].toFixed(1)}%</text>`;
            if(Math.abs(diff) > 0.01) html += `<text x="${x}" y="${h-20}" class="label-delta" text-anchor="middle" fill="${diff < 0 ? 'var(--danger)':'var(--baseline)'}">${diff > 0 ? '+':''}${diff.toFixed(2)}%</text>`;
            html += `<circle cx="${x}" cy="${y}" r="5" fill="var(--accent)" stroke="white" stroke-width="2" />`;
        });
        svg.innerHTML = html;
    }

    function renderTable(sim, idx, key) {
        const tbody = document.querySelector('#pop-table tbody'), curr = sim[idx], prev = sim[idx-1]; if(!curr || !prev) return;
        const getDen = (n) => (key === 'eligRate' ? n.h : (key === 'convRate' ? n.ext : n.elig)) || 1;
        const delta = curr[key] - prev[key];
        document.getElementById('total-delta').innerText = (delta > 0 ? '+' : '') + delta.toFixed(2) + '%';
        document.getElementById('total-delta').style.color = delta >= 0 ? 'var(--baseline)' : 'var(--danger)';
        document.getElementById('pop-title').innerText = delta >= 0 ? 'Top Drivers (Increase)' : 'Top Drivers (Decrease)';
        const sk = document.getElementById('pop-level').value;
        const all = new Set([...Object.keys(curr[sk]), ...Object.keys(prev[sk])]);
        const rows = Array.from(all).map(n => {
            const cP = ((prev[sk][n] || 0) / getDen(prev)) * 100, cC = ((curr[sk][n] || 0) / getDen(curr)) * 100;
            return { n: n || 'Organic', d: cC - cP };
        }).filter(r => delta >= 0 ? r.d > 0 : r.d < 0).sort((a,b) => delta >= 0 ? b.d - a.d : a.d - b.d).slice(0, 5);
        tbody.innerHTML = rows.map(r => `<tr><td><strong>${r.n}</strong></td><td><div style="width:100px; height:8px; background:#f1f5f9; border-radius:4px; overflow:hidden;"><div style="width:${Math.min(100, Math.abs(r.d)*20)}%; height:100%; background:${r.d > 0 ? 'var(--baseline)':'var(--danger)'};"></div></div></td><td style="color:${r.d < 0 ? 'var(--danger)':'var(--baseline)'}; font-weight:bold">${r.d > 0 ? '+':''}${r.d.toFixed(2)}%</td></tr>`).join('');
    }

    function toggleAll(cls, check) { document.querySelectorAll(`.${cls}-cb`).forEach(c => c.checked = check); update(); }
    worker.postMessage({ type: 'LOAD', url: 'offer_sup_dat.csv' });
</script>
</body>
</html>